# ğŸ¥ MediQuery-RAG ç§‘æ™®åŒ»ç–—æ™ºèƒ½åŠ©æ‰‹

åŸºäº **LangGraph + RAG + å¤šè½®è¿½é—®** çš„æ™ºèƒ½åŒ»ç–—é—®è¯Šç³»ç»Ÿ

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [å¼€å‘å†ç¨‹](#å¼€å‘å†ç¨‹)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å®‰è£…ä¸è¿è¡Œ](#å®‰è£…ä¸è¿è¡Œ)
- [ä½¿ç”¨æ¼”ç¤º](#ä½¿ç”¨æ¼”ç¤º)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

---

## é¡¹ç›®ç®€ä»‹

MediQuery-RAG æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½åŒ»ç–—é—®è¯Šç³»ç»Ÿï¼Œæ—¨åœ¨æä¾›ï¼š

- ğŸ©º **ç»“æ„åŒ–é—®è¯Š**ï¼šå¼•å¯¼å¼æ”¶é›†ç”¨æˆ·å¥åº·ä¿¡æ¯
- ğŸ¤– **æ™ºèƒ½è¿½é—®**ï¼šAI æ ¹æ®ç—‡çŠ¶è‡ªåŠ¨è¿½é—®å…³é”®ä¿¡æ¯ï¼ˆä½ç½®ã€æ€§è´¨ã€æŒç»­æ—¶é—´ç­‰ï¼‰
- ğŸ“Š **å¥åº·è¯„ä¼°**ï¼šè‡ªåŠ¨è®¡ç®— BMI/BMRï¼ŒAI åˆ†æèº«ä½“çŠ¶å†µ
- âš ï¸ **é£é™©é¢„è­¦**ï¼šå®æ—¶æ£€æµ‹é«˜å±ç—‡çŠ¶ï¼Œç´§æ€¥æƒ…å†µç«‹å³æé†’å°±åŒ»
- ğŸ“š **RAG çŸ¥è¯†åº“**ï¼šç»“åˆåŒ»å­¦çŸ¥è¯†åº“å’Œè”ç½‘æœç´¢ç”Ÿæˆå»ºè®®
- ğŸ’¾ **ç”¨æˆ·æ¡£æ¡ˆ**ï¼šæŒä¹…åŒ–å­˜å‚¨ç”¨æˆ·å¥åº·æ¡£æ¡ˆå’Œé—®è¯Šå†å²

---

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·ç•Œé¢å±‚                            â”‚
â”‚                    (CLI / Gradio Web)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  ç»“æ„åŒ–é—®è¯Šæ¨¡å—   â”‚  â”‚   ç§‘æ™®é—®ç­”æ¨¡å—   â”‚                  â”‚
â”‚  â”‚ (å¤šè½®è¿½é—®/é£é™©è¯„ä¼°)â”‚  â”‚  (è‡ªç”±å¯¹è¯)     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚           â”‚                    â”‚                            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                      â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              LangGraph å·¥ä½œæµå¼•æ“                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚Routerâ”‚â†’ â”‚Retrieveâ”‚â†’â”‚Grade â”‚â†’ â”‚WebSrcâ”‚â†’ â”‚Summaryâ”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       æ•°æ®å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ChromaDB    â”‚  â”‚ SQLite      â”‚  â”‚ JSON Files  â”‚         â”‚
â”‚  â”‚ (å‘é‡çŸ¥è¯†åº“) â”‚  â”‚ (å¯¹è¯å†å²)   â”‚  â”‚ (ç”¨æˆ·æ¡£æ¡ˆ)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       æ¨¡å‹å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Qwen2.5:7B      â”‚  â”‚ dmeta-embedding â”‚                  â”‚
â”‚  â”‚ (å¯¹è¯/æ¨ç†)      â”‚  â”‚ (ä¸­æ–‡å‘é‡åŒ–)     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¼€å‘å†ç¨‹

### ğŸ” ç¬¬ä¸€é˜¶æ®µï¼šåµŒå…¥æ¨¡å‹é€‰å‹

é¡¹ç›®åˆæœŸé¢ä¸´çš„æ ¸å¿ƒé—®é¢˜æ˜¯**ä¸­æ–‡è¯­ä¹‰ç†è§£**ã€‚æˆ‘ä»¬æµ‹è¯•äº†å¤šä¸ªåµŒå…¥æ¨¡å‹ï¼š

| æ¨¡å‹ | é—®é¢˜ |
|------|------|
| `nomic-embed-text` | å¯¹ä¸­æ–‡æ”¯æŒå·®ï¼Œè¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—ä¸å‡†ç¡® |
| `bge-m3` | æ•ˆæœä¸€èˆ¬ï¼Œæ£€ç´¢å¬å›ç‡ä¸ç†æƒ³ |
| `mxbai-embed-large` | è‹±æ–‡æ•ˆæœå¥½ï¼Œä¸­æ–‡æ•ˆæœå·® |
| **`shaw/dmeta-embedding-zh`** | âœ… ä¸“é—¨é’ˆå¯¹ä¸­æ–‡ä¼˜åŒ–ï¼Œè¯­ä¹‰ç†è§£å‡†ç¡® |

**æœ€ç»ˆé€‰æ‹©**ï¼š`shaw/dmeta-embedding-zh`

```python
# src/medical_engine.py
embeddings = OllamaEmbeddings(model="shaw/dmeta-embedding-zh")
```

### ğŸ—ï¸ ç¬¬äºŒé˜¶æ®µï¼šLangGraph å·¥ä½œæµæ­å»º

ä½¿ç”¨ LangGraph æ„å»º **Self-RAG** å·¥ä½œæµï¼Œå®ç°æ™ºèƒ½æ£€ç´¢å’Œç”Ÿæˆï¼š

```
START â†’ Router â†’ Retrieve â†’ Grade â†’ [é€šè¿‡] â†’ Summarizer â†’ END
                    â†‘         â”‚
                    â”‚    [ä¸é€šè¿‡]
                    â”‚         â†“
                    â†â”€â”€â”€ Rewrite Query
                              â”‚
                         [è¶…è¿‡3æ¬¡]
                              â†“
                         Web Search
```

### ğŸ©º ç¬¬ä¸‰é˜¶æ®µï¼šç»“æ„åŒ–é—®è¯Šç³»ç»Ÿ

ä»ç®€å•çš„é—®ç­”å‡çº§ä¸º**ç»“æ„åŒ–é—®è¯Šæµç¨‹**ï¼š

1. **ç”¨æˆ·è¯†åˆ«**ï¼šæ‰‹æœºå·ç™»å½•ï¼Œè€ç”¨æˆ·æ¢å¤æ¡£æ¡ˆ
2. **åŸºç¡€ä¿¡æ¯é‡‡é›†**ï¼šæ€§åˆ«ã€å¹´é¾„ã€èº«é«˜ã€ä½“é‡
3. **ç—…å²ä¿¡æ¯é‡‡é›†**ï¼šå®¶æ—ç—…å²ã€è¿‡æ•å²ã€æ…¢æ€§ç—…ã€ç”¨è¯æƒ…å†µ
4. **å’¨è¯¢ç›®çš„é€‰æ‹©**ï¼šå¥åº·ç®¡ç† / èº«ä½“ä¸é€‚
5. **ç—‡çŠ¶æè¿° + AI è¿½é—®**ï¼šæ™ºèƒ½æ”¶é›†ç—‡çŠ¶è¯¦æƒ…
6. **é£é™©è¯„ä¼°**ï¼šAI åˆ¤æ–­ç´§æ€¥ç¨‹åº¦
7. **RAG ç”Ÿæˆå»ºè®®**ï¼šç»“åˆçŸ¥è¯†åº“å’Œè”ç½‘æœç´¢

### ğŸ¤– ç¬¬å››é˜¶æ®µï¼šå¤šè½®æ™ºèƒ½è¿½é—®

å®ç°äº†åŸºäº **LangChain Messages** çš„å¯¹è¯è®°å¿†ï¼š

```python
messages = [
    SystemMessage(content="ä½ æ˜¯é—®è¯ŠåŒ»ç”Ÿ..."),
    HumanMessage(content="æˆ‘è‚šå­ç–¼"),
    AIMessage(content="è‚šå­å“ªä¸ªä½ç½®ç–¼ï¼Ÿ"),
    HumanMessage(content="ä¸‹è…¹éƒ¨"),
    AIMessage(content="æ˜¯ä»€ä¹ˆæ ·çš„ç–¼æ³•ï¼Ÿ"),
    HumanMessage(content="ç»ç—›"),
    # AI èƒ½çœ‹åˆ°å®Œæ•´å¯¹è¯å†å²ï¼Œä¸ä¼šé‡å¤æé—®
]
```

### ğŸ“œ ç¬¬äº”é˜¶æ®µï¼šå†å²æ‘˜è¦æ³¨å…¥

å®ç°ç”¨æˆ·å†å²é—®è¯Šè®°å½•çš„æ³¨å…¥ï¼Œè®©ç³»ç»Ÿèƒ½å¤Ÿï¼š
- è¯†åˆ«ç›¸ä¼¼ç—‡çŠ¶ï¼š"æ‚¨ä¸Šå‘¨ä¹Ÿå’¨è¯¢è¿‡å¤´ç—›"
- ç»“åˆå†å²ç»™å‡ºå»ºè®®ï¼š"è€ƒè™‘åˆ°æ‚¨å¤šæ¬¡å‡ºç°ç±»ä¼¼ç—‡çŠ¶..."

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. ğŸ©º æ™ºèƒ½å¥åº·é—®è¯Š

- ç»“æ„åŒ–é—®è¯Šæµç¨‹ï¼Œå¼•å¯¼ç”¨æˆ·å®Œæˆä¿¡æ¯å¡«å†™
- AI è‡ªåŠ¨è¿½é—®å…³é”®ä¿¡æ¯ï¼ˆä½ç½®ã€æ€§è´¨ã€æŒç»­æ—¶é—´ã€è¯±å› ã€ä¼´éšç—‡çŠ¶ï¼‰
- æœ€å¤šè¿½é—® 3 è½®ï¼Œé¿å…ç”¨æˆ·ç–²åŠ³
- å®æ—¶é£é™©è¯„ä¼°ï¼Œé«˜å±ç—‡çŠ¶ç«‹å³é¢„è­¦

### 2. ğŸ“Š å¥åº·æŒ‡æ ‡è®¡ç®—

- **BMI**ï¼šèº«ä½“è´¨é‡æŒ‡æ•°
- **BMR**ï¼šåŸºç¡€ä»£è°¢ç‡
- **ç†æƒ³ä½“é‡**ï¼šæ ¹æ®èº«é«˜æ€§åˆ«è®¡ç®—
- **AI è¯„ä¼°**ï¼šç»¼åˆåˆ†æèº«ä½“çŠ¶å†µ

### 3. âš ï¸ é£é™©è¯„ä¼°ç³»ç»Ÿ

| ç­‰çº§ | è§¦å‘æ¡ä»¶ | å“åº” |
|------|----------|------|
| CRITICAL | è‡ªæ€/è‡ªæ®‹å…³é”®è¯ | ç«‹å³ç»ˆæ­¢ï¼Œæä¾›å¿ƒç†æ´åŠ©çƒ­çº¿ |
| HIGH | AI åˆ¤æ–­éœ€ç´§æ€¥å°±åŒ» | å¼ºçƒˆå»ºè®® 24 å°æ—¶å†…å°±åŒ» |
| MEDIUM | ä¸¥é‡ç¨‹åº¦ â‰¥7 åˆ†æˆ–ä¸­ç­‰é£é™©å…³é”®è¯ | å»ºè®®è¿‘æœŸå°±åŒ» |
| LOW | å…¶ä»–æƒ…å†µ | æä¾›å¥åº·å»ºè®® |

### 4. ğŸ“š RAG çŸ¥è¯†æ£€ç´¢

- **æœ¬åœ°çŸ¥è¯†åº“**ï¼šChromaDB å‘é‡å­˜å‚¨åŒ»å­¦ç§‘æ™®å†…å®¹
- **è”ç½‘æœç´¢**ï¼šTavily API è·å–æœ€æ–°ä¿¡æ¯
- **Self-RAG**ï¼šè‡ªåŠ¨è¯„ä¼°æ£€ç´¢è´¨é‡ï¼Œå¿…è¦æ—¶é‡å†™æŸ¥è¯¢æˆ–è”ç½‘æœç´¢

### 5. ğŸ’¾ ç”¨æˆ·æ¡£æ¡ˆç®¡ç†

- æ‰‹æœºå·å“ˆå¸Œä½œä¸ºç”¨æˆ· ID
- JSON æ ¼å¼å­˜å‚¨ç”¨æˆ·æ¡£æ¡ˆ
- é—®è¯Šè®°å½•æŒ‰ä¼šè¯ä¿å­˜
- è‡ªåŠ¨ç”Ÿæˆ Markdown æ ¼å¼çš„å¥åº·æ¡£æ¡ˆ

---

## é¡¹ç›®ç»“æ„

```
MediQuery-RAG/
â”œâ”€â”€ main.py                     # ç¨‹åºå…¥å£
â”œâ”€â”€ .env                        # ç¯å¢ƒå˜é‡ (TAVILY_API_KEY)
â”œâ”€â”€ medical_db/                 # ChromaDB å‘é‡æ•°æ®åº“
â”œâ”€â”€ user_data/                  # ç”¨æˆ·æ¡£æ¡ˆå­˜å‚¨
â”‚   â””â”€â”€ {user_id}/
â”‚       â”œâ”€â”€ profile.json        # ç”¨æˆ·åŸºç¡€ä¿¡æ¯
â”‚       â”œâ”€â”€ sessions/           # é—®è¯Šè®°å½•
â”‚       â”‚   â””â”€â”€ 20260205_xxxx.json
â”‚       â””â”€â”€ history.md          # Markdown æ ¼å¼æ¡£æ¡ˆ
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py             # å…¨å±€é…ç½®
â”‚
â”œâ”€â”€ data/
â”‚   â””â”€â”€ medical_data.txt        # åŒ»å­¦çŸ¥è¯†åº“åŸå§‹æ•°æ®
â”‚
â””â”€â”€ src/
    â”œâ”€â”€ medical_engine.py       # æ ¸å¿ƒå¼•æ“ï¼šLLM/å‘é‡åº“/æœç´¢å·¥å…·åˆå§‹åŒ–
    â”œâ”€â”€ ingest_medical.py       # çŸ¥è¯†åº“å…¥åº“è„šæœ¬
    â”œâ”€â”€ tools.py                # åŒ»å­¦è®¡ç®—å·¥å…· (BMI/BMR/ç†æƒ³ä½“é‡)
    â”‚
    â”œâ”€â”€ agents/                 # LangGraph å·¥ä½œæµ
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ graph.py            # å·¥ä½œæµå®šä¹‰å’Œç¼–è¯‘
    â”‚   â””â”€â”€ nodes.py            # å„èŠ‚ç‚¹å®ç°
    â”‚
    â”œâ”€â”€ consultation/           # ç»“æ„åŒ–é—®è¯Šæ¨¡å—
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â””â”€â”€ structured_consultation.py  # é—®è¯Šæ ¸å¿ƒé€»è¾‘
    â”‚
    â”œâ”€â”€ memory/                 # è®°å¿†æ¨¡å—
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ health_extractor.py # å¥åº·ä¿¡æ¯æå–
    â”‚   â”œâ”€â”€ profile_store.py    # æ¡£æ¡ˆå­˜å‚¨
    â”‚   â””â”€â”€ summary.py          # æ‘˜è¦ç”Ÿæˆ
    â”‚
    â”œâ”€â”€ core/                   # å·¥å…·å‡½æ•°
    â”‚   â””â”€â”€ utils.py            # æ¨¡å¼æ£€æµ‹/æ–‡æ¡£è¯„åˆ†/æŸ¥è¯¢é‡å†™
    â”‚
    â””â”€â”€ ui/                     # ç”¨æˆ·ç•Œé¢
        â””â”€â”€ interface.py        # CLI ç•Œé¢å®ç°
```

---

## å„æ¨¡å—åŠŸèƒ½è¯´æ˜

### `src/medical_engine.py` - æ ¸å¿ƒå¼•æ“

```python
# åˆå§‹åŒ–åµŒå…¥æ¨¡å‹ï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼‰
embeddings = OllamaEmbeddings(model="shaw/dmeta-embedding-zh")

# åˆå§‹åŒ–å¯¹è¯æ¨¡å‹
llm = ChatOllama(model="qwen2.5:7b", temperature=0)

# åˆå§‹åŒ–å‘é‡æ•°æ®åº“
vectorstore = Chroma(persist_directory=DB_PATH, embedding_function=embeddings)

# åˆå§‹åŒ–è”ç½‘æœç´¢
web_search_tool = TavilySearch(max_results=3)
```

### `src/agents/graph.py` - LangGraph å·¥ä½œæµ

```python
def build_graph(nodes: dict):
    workflow = StateGraph(MedicalState)
    
    # æ³¨å†ŒèŠ‚ç‚¹
    workflow.add_node("router", nodes["router"])
    workflow.add_node("retrieve", nodes["retrieve"])
    workflow.add_node("grade_loop", nodes["grade_loop"])
    workflow.add_node("web_search", nodes["web_search"])
    workflow.add_node("summarizer", nodes["summarizer"])
    
    # å®šä¹‰æµç¨‹
    workflow.add_edge(START, "router")
    workflow.add_conditional_edges("router", route_after_router)
    workflow.add_edge("retrieve", "grade_loop")
    workflow.add_conditional_edges("grade_loop", route_self_rag)
    workflow.add_edge("web_search", "grade_loop")
    workflow.add_edge("summarizer", END)
    
    return workflow.compile(checkpointer=memory)
```

### `src/agents/nodes.py` - èŠ‚ç‚¹å®ç°

| èŠ‚ç‚¹ | åŠŸèƒ½ |
|------|------|
| `router_node` | åˆ†æé—®é¢˜ç±»å‹ï¼Œå†³å®šå¤„ç†æµç¨‹ |
| `retrieve_node` | ä»å‘é‡åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£ |
| `grade_and_generate_node` | è¯„ä¼°æ–‡æ¡£è´¨é‡ï¼Œç”Ÿæˆå›ç­”æˆ–è§¦å‘é‡è¯• |
| `web_search_node` | è”ç½‘æœç´¢è¡¥å……ä¿¡æ¯ |
| `summarizer_node` | æ ¼å¼åŒ–æœ€ç»ˆè¾“å‡º |

### `src/consultation/structured_consultation.py` - é—®è¯Šæ ¸å¿ƒ

```python
class StructuredConsultation:
    def identify_user(identifier)      # ç”¨æˆ·è¯†åˆ«
    def start_session()                # å¼€å§‹é—®è¯Šä¼šè¯
    def get_current_question()         # è·å–å½“å‰é—®é¢˜
    def process_answer(answer)         # å¤„ç†ç”¨æˆ·å›ç­”
    def _check_need_followup()         # AI åˆ¤æ–­æ˜¯å¦éœ€è¦è¿½é—®
    def _assess_risk_realtime(text)    # å®æ—¶é£é™©è¯„ä¼°
    def get_consultation_summary()     # è·å–é—®è¯Šæ‘˜è¦
    def get_history_summary()          # è·å–å†å²æ‘˜è¦
    def save_session()                 # ä¿å­˜ä¼šè¯
    def generate_history_markdown()    # ç”Ÿæˆ Markdown æ¡£æ¡ˆ
```

### `src/ui/interface.py` - ç”¨æˆ·ç•Œé¢

```python
def main_menu()                    # ä¸»èœå•
def structured_consultation_flow() # ç»“æ„åŒ–é—®è¯Šæµç¨‹
def free_qa_mode()                 # è‡ªç”±é—®ç­”æ¨¡å¼
def _build_rag_query(summary)      # æ„å»º RAG æŸ¥è¯¢
```

### `src/tools.py` - åŒ»å­¦è®¡ç®—å·¥å…·

```python
@tool
def calculate_bmi(height_cm, weight_kg):
    """è®¡ç®— BMI æŒ‡æ•°"""
    
@tool
def calculate_bmr(weight_kg, height_cm, age, gender):
    """è®¡ç®—åŸºç¡€ä»£è°¢ç‡"""
    
@tool
def calculate_ideal_weight(height_cm, gender):
    """è®¡ç®—ç†æƒ³ä½“é‡"""
```

---

## å®‰è£…ä¸è¿è¡Œ

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†é¡¹ç›®
git clone <repository_url>
cd MediQuery-RAG

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. å®‰è£… Ollama æ¨¡å‹

```bash
# å®‰è£… Ollama (å¦‚æœæœªå®‰è£…)
curl -fsSL https://ollama.com/install.sh | sh

# ä¸‹è½½æ‰€éœ€æ¨¡å‹
ollama pull qwen2.5:7b
ollama pull shaw/dmeta-embedding-zh
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# åˆ›å»º .env æ–‡ä»¶
echo "TAVILY_API_KEY=your_api_key_here" > .env
```

> ğŸ’¡ Tavily API Key å¯åœ¨ [tavily.com](https://tavily.com) å…è´¹è·å–

### 4. åˆå§‹åŒ–çŸ¥è¯†åº“

```bash
python3 src/ingest_medical.py
```

### 5. è¿è¡Œç¨‹åº

```bash
python3 main.py
```

---

## ä½¿ç”¨æ¼”ç¤º

### å¯åŠ¨ç•Œé¢

```
âš™ï¸ æ­£åœ¨åˆå§‹åŒ–åŒ»å­¦å¼•æ“ (LLM & VectorStore)...
âœ… Tavily è”ç½‘æœç´¢å·²å¯ç”¨

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ğŸ¥ ç§‘æ™®åŒ»ç–—æ™ºèƒ½åŠ©æ‰‹                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                          â•‘
â•‘   è¯·é€‰æ‹©æœåŠ¡æ¨¡å¼ï¼š                                        â•‘
â•‘                                                          â•‘
â•‘   [1] ğŸ©º æ™ºèƒ½å¥åº·é—®è¯Šï¼ˆæ¨èï¼‰                             â•‘
â•‘   [2] ğŸ“š åŒ»å­¦ç§‘æ™®é—®ç­”                                    â•‘
â•‘                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### æ™ºèƒ½é—®è¯Šæµç¨‹

```
ğŸ“± æ‚¨çš„æ‰‹æœºå·ï¼š15166676667

ğŸ‘‹ æ¬¢è¿å›æ¥ï¼
   æ¡£æ¡ˆID: e9ac2f13...
   
ğŸ“‹ æ‚¨çš„å·²æœ‰æ¡£æ¡ˆï¼š
   â”œâ”€â”€ æ€§åˆ«: ç”·
   â”œâ”€â”€ å¹´é¾„: 19å²
   â”œâ”€â”€ èº«é«˜: 175.0cm | ä½“é‡: 75.0kg
   â”œâ”€â”€ BMI: 24.5
   â””â”€â”€ æ— å·²çŸ¥æ…¢æ€§ç—…

ã€é—®é¢˜ 1ã€‘è¯·é—®æ‚¨ä»Šå¤©å’¨è¯¢çš„ç›®çš„æ˜¯ï¼Ÿ
   1. å¥åº·ç®¡ç†å»ºè®®
   2. èº«ä½“ä¸é€‚å’¨è¯¢

ğŸ‘¤ æ‚¨çš„å›ç­”ï¼š2

ã€é—®é¢˜ 2ã€‘è¯·ç®€å•æè¿°ä¸€ä¸‹æ‚¨å“ªé‡Œä¸èˆ’æœï¼Ÿ

ğŸ‘¤ æ‚¨çš„å›ç­”ï¼šè‚šå­ç–¼
  ğŸ¤” [AIæ­£åœ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è¿½é—®...]
  ğŸ’¡ [è¿½é—®åŸå› : éœ€è¦ç¡®å®šç–¼ç—›ä½ç½®]

ã€é—®é¢˜ 3ã€‘è‚šå­å“ªä¸ªä½ç½®ç–¼ï¼Ÿ
   1. ä¸Šè…¹éƒ¨
   2. ä¸‹è…¹éƒ¨
   3. è‚šè„å‘¨å›´
   4. æ•´ä¸ªè‚šå­

ğŸ‘¤ æ‚¨çš„å›ç­”ï¼š2
  ğŸ¤” [AIæ­£åœ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è¿½é—®...]
  ğŸ’¡ [è¿½é—®åŸå› : éœ€è¦äº†è§£ç–¼ç—›æ€§è´¨]

ã€é—®é¢˜ 4ã€‘æ˜¯ä»€ä¹ˆæ ·çš„ç–¼æ³•ï¼Ÿ
   1. ç»ç—›
   2. èƒ€ç—›
   3. éšç—›
   4. åˆºç—›

ğŸ‘¤ æ‚¨çš„å›ç­”ï¼š1
  âœ… [ä¿¡æ¯å·²è¶³å¤Ÿï¼Œæ— éœ€è¿½é—®]

ã€é—®é¢˜ 5ã€‘ä¸¥é‡ç¨‹åº¦æ‰“å‡ åˆ†ï¼Ÿ(1-10)

ğŸ‘¤ æ‚¨çš„å›ç­”ï¼š6

ğŸ“Š è¯„ä¼°ç»“æœ
   â”œâ”€â”€ ä¸»è¯‰: è‚šå­ç–¼
   â”œâ”€â”€ æŒç»­æ—¶é—´: -
   â”œâ”€â”€ ä¸¥é‡ç¨‹åº¦: 6.0/10
   â””â”€â”€ é£é™©ç­‰çº§: LOW

ğŸ“š [çŸ¥è¯†åº“] æ£€ç´¢åˆ° 5 æ¡ç›¸å…³å†…å®¹
ğŸŒ [è”ç½‘æœç´¢] æ‰¾åˆ° 3 æ¡ç»“æœ
ğŸ’¡ [æ­£åœ¨ç”Ÿæˆå»ºè®®...]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– å›ç­”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ ¹æ®æ‚¨çš„æè¿°ï¼Œä¸‹è…¹éƒ¨ç»ç—›å¯èƒ½çš„åŸå› åŒ…æ‹¬...

[è¯¦ç»†çš„å¥åº·å»ºè®®]

ğŸ“‹ å·²å‚è€ƒä½ çš„å¥åº·æ¡£æ¡ˆ
ğŸ’¡ ä»¥ä¸Šä¿¡æ¯ä»…ä¾›ç§‘æ™®å­¦ä¹ ï¼Œå…·ä½“è¯·éµåŒ»å˜±ã€‚
```

---

## æŠ€æœ¯ç»†èŠ‚

### LangGraph åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨

#### 1. çŠ¶æ€å®šä¹‰

```python
class MedicalState(TypedDict):
    messages: Annotated[list, add_messages]  # å¯¹è¯å†å²
    mode: str                                 # æ¨¡å¼: assessment/science
    user_id: str                              # ç”¨æˆ· ID
    documents: List[str]                      # æ£€ç´¢åˆ°çš„æ–‡æ¡£
    loop_step: int                            # å¾ªç¯æ¬¡æ•°
    used_web_search: bool                     # æ˜¯å¦å·²è”ç½‘æœç´¢
    health_profile: str                       # ç”¨æˆ·å¥åº·æ¡£æ¡ˆ
    final_answer: str                         # æœ€ç»ˆç­”æ¡ˆ
```

#### 2. æ¡ä»¶è·¯ç”±

```python
def route_self_rag(state):
    decision = state.get("final_answer")
    if decision == "ready":
        return "summarizer"      # ç”Ÿæˆå®Œæˆ
    elif decision == "go_web":
        return "web_search"      # éœ€è¦è”ç½‘æœç´¢
    return "retrieve"            # é‡æ–°æ£€ç´¢
```

#### 3. æ£€æŸ¥ç‚¹æŒä¹…åŒ–

```python
conn = sqlite3.connect(CHAT_HISTORY_DB)
memory = SqliteSaver(conn)
app = workflow.compile(checkpointer=memory)
```

### å¤šè½®è¿½é—®çš„æ¶ˆæ¯è®°å¿†

```python
def _check_need_followup(self):
    # æ„å»ºæ¶ˆæ¯åˆ—è¡¨
    messages = [SystemMessage(content=system_prompt)]
    
    # æ·»åŠ ä¸»è¯‰
    messages.append(HumanMessage(content=f"æˆ‘çš„ç—‡çŠ¶æ˜¯ï¼š{chief_complaint}"))
    
    # æ·»åŠ å†å²è¿½é—®
    for qa in session.followup_qa:
        messages.append(AIMessage(content=qa["question"]))
        messages.append(HumanMessage(content=qa["answer"]))
    
    # AI åˆ¤æ–­æ˜¯å¦ç»§ç»­è¿½é—®
    messages.append(HumanMessage(content="è¯·åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­è¿½é—®"))
    
    response = self.llm.invoke(messages)
```

---

## ä¾èµ–è¯´æ˜

```
langchain>=0.2.0
langchain-ollama>=0.1.0
langchain-chroma>=0.1.0
langchain-tavily>=0.1.0
langgraph>=0.2.0
langgraph-checkpoint-sqlite>=1.0.0
chromadb>=0.4.0
python-dotenv>=1.0.0
```

---

## å…è´£å£°æ˜

âš ï¸ **æœ¬ç³»ç»Ÿä»…ä¾›å¥åº·ç§‘æ™®å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç”Ÿè¯Šæ–­ã€‚å¦‚æœ‰èº«ä½“ä¸é€‚ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚**

---

## è‡´è°¢

- [LangChain](https://langchain.com/) - LLM åº”ç”¨æ¡†æ¶
- [LangGraph](https://langchain-ai.github.io/langgraph/) - å·¥ä½œæµå¼•æ“
- [Ollama](https://ollama.com/) - æœ¬åœ°æ¨¡å‹è¿è¡Œ
- [ChromaDB](https://www.trychroma.com/) - å‘é‡æ•°æ®åº“
- [Tavily](https://tavily.com/) - è”ç½‘æœç´¢ API

---

## License

MIT License
